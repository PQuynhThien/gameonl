<!DOCTYPE html>
<html>
<head>
    <title>Băng và Lửa Online</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; }
        canvas { display: block; margin: 0 auto; }
        #ui { position: absolute; top: 10px; left: 10px; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">Dùng phím mũi tên để đi, Click chuột để BẮN!</div>

    <script>
        // THAY LINK RENDER CỦA BẠN VÀO ĐÂY
        const socket = io("https://gameonl.onrender.com"); 

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            physics: { default: 'arcade' },
            scene: { preload: preload, create: create, update: update }
        };

        const game = new Phaser.Game(config);
        let player;
        let otherPlayers = {};
        let cursors;
        let bullets;

        function preload() {}

        function create() {
            // Tạo nền lưới cổ điển
            this.add.grid(0, 0, 4000, 4000, 50, 50, 0x111111).setAltFillStyle(0x000000).setOrigin(0);
            
            bullets = this.physics.add.group();
            cursors = this.input.keyboard.createCursorKeys();

            socket.on('currentPlayers', (players) => {
                Object.keys(players).forEach((id) => {
                    if (id === socket.id) {
                        addPlayer(this, players[id]);
                        this.cameras.main.startFollow(player);
                    } else if (!otherPlayers[id]) {
                        addOtherPlayers(this, players[id]);
                    }
                });
            });

            socket.on('playerMoved', (info) => {
                if (otherPlayers[info.id]) {
                    otherPlayers[info.id].setPosition(info.x, info.y);
                }
            });

            socket.on('newBullet', (data) => {
                const color = data.team === 'fire' ? 0xff4500 : 0x00bfff;
                let b = bullets.create(data.x, data.y, null);
                b.setCircle(5);
                b.body.setAllowGravity(false);
                this.add.circle(data.x, data.y, 6, color);
                this.physics.velocityFromRotation(data.angle, 400, b.body.velocity);
            });

            socket.on('playerDisconnected', (id) => {
                if (otherPlayers[id]) {
                    otherPlayers[id].destroy();
                    delete otherPlayers[id];
                }
            });

            // Click chuột để bắn
            this.input.on('pointerdown', (pointer) => {
                if (player) {
                    const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.worldX, pointer.worldY);
                    socket.emit('shoot', { x: player.x, y: player.y, angle: angle });
                }
            });
        }

        function addPlayer(scene, info) {
            const color = info.team === 'fire' ? 0xff4500 : 0x00bfff;
            player = scene.add.container(info.x, info.y);
            let body = scene.add.circle(0, 0, 20, color).setStrokeStyle(2, 0xffffff);
            let text = scene.add.text(-25, -40, "BẠN (" + info.team + ")", { fontSize: '14px' });
            player.add([body, text]);
            scene.physics.world.enable(player);
        }

        function addOtherPlayers(scene, info) {
            const color = info.team === 'fire' ? 0xff4500 : 0x00bfff;
            let other = scene.add.container(info.x, info.y);
            let body = scene.add.circle(0, 0, 20, color);
            let text = scene.add.text(-25, -40, info.name, { fontSize: '12px' });
            other.add([body, text]);
            other.id = info.id;
            otherPlayers[info.id] = other;
        }

        function update() {
            if (player) {
                let vx = 0, vy = 0;
                if (cursors.left.isDown) vx = -200;
                else if (cursors.right.isDown) vx = 200;
                if (cursors.up.isDown) vy = -200;
                else if (cursors.down.isDown) vy = 200;

                player.body.setVelocity(vx, vy);
                if (vx !== 0 || vy !== 0) {
                    socket.emit('move', { x: player.x, y: player.y });
                }
            }
        }
    </script>
</body>
</html>
